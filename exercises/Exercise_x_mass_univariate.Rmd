---
title: "Mass univariate testing"
output: html_notebook
---

### Mass univariate tests

Often we want to run a whole series of tests across multiple timepoints, electrodes, frequency bands etc.

In R, we iterate can over lists, performing the same operation on each item in the list.

Ideally, we need a list of dataframes, each containing a subset of our full dataframe.

*Nest()* from *tidyr* turns several columns of a dataframe into a single column that is a list of dataframes. 

Create a nested data frame for each time point.

```{r Nest_df}
time_nest <- nest(final_df, -Time)
head(time_nest)
```

Now we need to iterate through our list. 

**purrr** 

Use *map* to go through the list and run a t-test on each timepoint. 

This makes it simple iterate through each timepoint using **map** commands from *purrr*. Map command (map, map_dbl, map_df) take a list as input and perform a function on each element of that list. We'll add an extra column to our nested data frame containing the output of the t.test() function applied to each element of the *data* list within the time_nest frame.

```{r run_t_tests}
time_nest <- mutate(time_nest,
                    stats = map(data, ~t.test(amplitude ~ Object,
                                              paired = TRUE, data = .x)))
head(time_nest)
```

We now have a data frame with the results of the t.test function for each timepoint. Suppose you now want to retrieve the t.test results for a specific timepoint. You can access list elements using double brackets [[]]; you would need to find the right row number for the timepoint you want, and enclose that in the brackets.

```{r query_nest}
time_nest$stats[[10]]
```

Alternatively, we can use map to iterate through the list and extract, for example, each p-value.

```{r get_pvals}
time_nest %>% 
  mutate(pvals = map_dbl(stats, "p.value")) 
```
Alternatively, we can use *tidy()* to convert our statistical test results into a one-line data frame. Then we remove the original data using *select()* and *unnest()* to get back a data frame with a column for each element of the statistical test.

```{r levStats}
stat_out <- levCatGA %>%
  nest(-Time) %>%
  mutate(stats = (map(data, ~broom::tidy(t.test(amplitude~Category, paired = TRUE, data = .x))))) %>%
  select(-data) %>%
  unnest()
```

