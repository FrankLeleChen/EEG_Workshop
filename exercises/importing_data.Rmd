---
title: "How to get your data into R"
output: html_notebook
---

For this exercise, we'll need the following packages:

```{r load_packages, echo = FALSE}
library(tidyverse)
library(h5)
```

## Loading files from Matlab

Two of the most popular EEG processing tools are the Fieldtrip and EEGLAB packages in Matlab. Both packages save in Matlab's native .mat format, despite EEGLAB's .set filename. More recent Matlab files (v7.3 format) are saved in the [HDF5]("https://support.hdfgroup.org/HDF5/") format. Thus, both .set from EEGLAB and .mat from Fieldtrip can be read into R using the *h5* package. Note that .set files must be saved as a *single file* for this method to work. If they are saved as two files - .set and .fdt - an additional step is needed. 

### EEGLAB

First let's load a single EEGLAB .set file.

```{r load_mat_file}
data_h5 <- h5file('../data/ObjLockS1.set','r')
data_h5
```

HDF5 is a hierarchical data format. Here we've opened it in read-only mode ('r'), as we won't be saving anything to it. At the first level, the file contains two **groups** - "#refs#" and "EEG". EEG is the important one. A full list of the contents of "EEG" can be accessed by subsetting the object as below:

```{r eeg_structure}
data_h5["EEG"]
```

The EEG group essentially corresponds to the Matlab EEG structure. Thus the information from the EEG structure can be retrieved by through subsetting. For example, say we want the sampling rate. We can get its record using ["EEG/srate/"], which tells that 'srate' contains a 1x1 numeric variable, which we can access using [1]:

```{r get_srate}
data_h5["EEG/srate/"]
data_h5["EEG/srate/"][1]
```

A useful thing to know is that any characters or strings are saved as integers and need to be converted back to characters. We can do that simply by converting them to hexadecimal and then looking up the relevant ASCII code. For example, the path the file was saved to can be retrieved as below.

More pressing for us is how to access the EEG data. We can extract it through subsetting, as above.

```{r get_eeg_data}
eeg_data <- data_h5["/EEG/data"][] 
dim(eeg_data)
```

This gives us, in this case, a 375 by 205 by 64 matrix - 375 trials, 205 timepoints, 64 channels.

We want to get from there to a nice, R-friendly data frame: three columns (trial number, timepoint, channel), with one observation per row. No problem! Since the EEG structure contains fields that hold the number of trials, the time for each sampling point, and the number of channels, we can use to *expand.grid* to create an empty data.frame with every possible combination of trial number, timepoint, and channel, and then simply collapse our matrix into a single vector using *c()*.

```{r create_data_frame}
timepoints <- data_h5["/EEG/times/"][]
n_trials <- 1:data_h5["EEG/trials/"][]
n_channels <- 1:data_h5["EEG/nbchan/"][]
EEG_df <- expand.grid(trials = n_trials, times = timepoints, electrode = n_channels)
EEG_df$amplitude <- c(eeg_data)
head(EEG_df)
```

Just to show that this creates a sensible dataset, here is a very basic ERP plot.

```{r plot_ERPs}
EEG_df %>%
  group_by(times, electrode) %>%
  summarise(amplitude = mean(amplitude)) %>%
  ggplot(aes(x = times, y = amplitude, group = electrode)) + geom_line() + theme_bw()
```

We're still missing a few things before this is a fully useable data frame. We don't have channel labels, and we have no record of which trial belongs to which condition.

### Getting channel labels and locations

Channel locations and labels are stored in structures inside the overarching EEG structure. Unfortunately, *h5* cannot currently read nested structure arrays from Matlab files. Thankfully, EEGLAB can save the channel location structure as  text file, which is easily readable. 

```{r load_locations}
chan_locs <- read_delim("../data/chan_locs_biosemiLE.ced", 
                                  "\t", escape_double = FALSE, trim_ws = TRUE)
head(chan_locs)
```

For now we'll focus on getting the channel labels. What we need to do is match the channel label to the channel number in our EEG data file. 

```{r}

chan_locs %>%
  select(Number, labels) %>%
  left_join(.x, EEG_df,by = c("Number", "electrode"))

```

```{r two_files_eeglab}
data_2files <- h5file('../data/ObjLockS1TwoFiles.set','r')
```
```{r}

```

## Loading a csv




```{r get_filepath}
as.raw(data_h5["EEG/filepath"][])
rawToChar(as.raw(data_h5["EEG/filepath"][]))
```